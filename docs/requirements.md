# 要件定義書

## 1. プロジェクト概要

### 1.1 プロジェクト名
Raspberry Pi サーボモーター複数制御システム

### 1.2 目的
Raspberry PiとAdafruit Servo HATを使用して、複数のSG90サーボモーターを制御するPythonアプリケーションを開発する。本システムは、初学者でも理解しやすく、拡張性の高い設計とする。

### 1.3 スコープ
- SG90サーボモーターの基本制御機能
- 複数サーボモーターの同期制御機能
- PWM信号による角度制御（0-180度）
- I2C通信によるServo HAT制御

## 2. ハードウェア要件

### 2.1 必須ハードウェア
| 機器名 | 仕様 | 数量 | 備考 |
|---|---|---|---|
| Raspberry Pi | Model 3以降推奨 | 1 | Zero、A+、B+、2、3、4、5対応 |
| Adafruit 16-Channel PWM/Servo HAT | PCA9685チップ搭載 | 1 | I2Cアドレス0x40（デフォルト） |
| SG90サーボモーター | 動作電圧4.8-6V | 1-16 | 最大16個まで接続可能 |
| 外部電源 | 5-6V安定化電源 | 1 | 推奨容量: サーボ1個あたり250mA |
| ジャンパーワイヤー | サーボ接続用 | 適量 | - |

### 2.2 サーボモーター仕様（SG90）
| 項目 | 値 |
|---|---|
| 動作電圧 | 4.8V〜6V |
| 動作電流 | 待機時10mA、動作時100〜250mA |
| 回転角度 | 180度（±90度） |
| 制御方式 | PWM（20ms周期、1-2msパルス幅） |
| パルス幅-角度対応 | 1.0ms=0度、1.5ms=90度、2.0ms=180度 |
| 動作速度 | 0.1秒/60度（4.8V） |
| 精度 | ±1度 |

### 2.3 Servo HAT仕様
| 項目 | 値 |
|---|---|
| 制御可能チャンネル数 | 16チャンネル |
| PWM分解能 | 12ビット（4096段階） |
| PWM周波数 | 最大1.6kHz |
| 通信方式 | I2C（2線式） |
| デフォルトI2Cアドレス | 0x40 |

## 3. ソフトウェア要件

### 3.1 システム要件
| 項目 | 要件 |
|---|---|
| OS | Raspberry Pi OS（推奨: Bullseye以降） |
| Python | 3.7以上 |
| I2C | 有効化必須 |

### 3.2 依存ライブラリ
| ライブラリ名 | バージョン | 用途 |
|---|---|---|
| adafruit-blinka | 最新版 | CircuitPython環境サポート |
| adafruit-circuitpython-servokit | 最新版 | Servo HAT制御 |

### 3.3 機能要件

#### 3.3.1 基本制御機能（必須）
- **FR-001**: ServoKitの初期化（16チャンネル対応）
- **FR-002**: 単一サーボの角度制御（0-180度）
- **FR-003**: 角度指定の精度（整数および小数点以下対応）
- **FR-004**: サーボ動作待機時間の制御
- **FR-005**: プログラム終了時の安全停止処理（中央位置90度への移動）

#### 3.3.2 複数サーボ制御機能（必須）
- **FR-101**: 複数サーボチャンネルの管理（リスト形式）
- **FR-102**: 複数サーボの同期角度設定
- **FR-103**: 動作パターンの定義と実行
- **FR-104**: チャンネルと角度の対応付け制御
- **FR-105**: 全サーボの一括中央位置復帰

#### 3.3.3 ユーザーインターフェース（必須）
- **FR-201**: コンソール出力による動作状態表示
- **FR-202**: チャンネル番号と角度の表示
- **FR-203**: パターン番号と内容の表示
- **FR-204**: Ctrl+Cによる割り込み処理

### 3.4 非機能要件

#### 3.4.1 性能要件
- **NFR-001**: サーボ応答時間の考慮（60度回転に0.1秒）
- **NFR-002**: 安全マージンを含む待機時間（推奨2-3秒）
- **NFR-003**: I2C通信の安定性確保

#### 3.4.2 信頼性要件
- **NFR-101**: 異常終了時のサーボ安全停止
- **NFR-102**: エラーハンドリング（KeyboardInterrupt対応）
- **NFR-103**: 電源投入順序の明確化（外部電源→Raspberry Pi）

#### 3.4.3 保守性要件
- **NFR-201**: コードの可読性（日本語コメント必須）
- **NFR-202**: 変数名・関数名の明確性
- **NFR-203**: マジックナンバーの定数化
- **NFR-204**: PEP 8準拠

#### 3.4.4 拡張性要件
- **NFR-301**: チャンネル数の容易な変更
- **NFR-302**: 動作パターンの追加容易性
- **NFR-303**: 新規機能の組み込み容易性

## 4. 開発成果物

### 4.1 プログラムファイル

#### 4.1.1 基本制御プログラム
- **ファイル名**: `src/servo_basic.py`
- **機能**: 単一サーボの基本的な角度制御（0度、90度、180度の往復）
- **対象チャンネル**: チャンネル0
- **動作パターン**: 0度→90度→180度→90度の繰り返し

#### 4.1.2 複数サーボ制御プログラム
- **ファイル名**: `src/servo_multi.py`
- **機能**: 2つのサーボの同期制御
- **対象チャンネル**: チャンネル0、1
- **動作パターン**:
  - パターン1: [0, 180]
  - パターン2: [45, 135]
  - パターン3: [180, 0]
  - パターン4: [90, 90]

### 4.2 ドキュメント

#### 4.2.1 セットアップガイド
- **ファイル名**: `docs/setup.md`
- **内容**: ハードウェア配線、I2C有効化、ライブラリインストール手順

#### 4.2.2 ハードウェア接続図
- **ファイル名**: `docs/hardware_connection.md`
- **内容**: Servo HATとサーボモーターの配線図、ピン配置

#### 4.2.3 使用方法マニュアル
- **ファイル名**: `docs/usage.md`
- **内容**: プログラムの実行方法、パラメータ設定、トラブルシューティング

### 4.3 サンプルコード
- **ディレクトリ**: `examples/`
- **内容**: 応用例、カスタマイズ例

## 5. システムアーキテクチャ

### 5.1 通信構成
```
Raspberry Pi (Python)
    ↓ I2C通信（GPIO 2, 3）
Adafruit Servo HAT (PCA9685)
    ↓ PWM信号（16チャンネル）
SG90サーボモーター × 1-16個
```

### 5.2 制御フロー

#### 5.2.1 基本制御フロー
1. ServoKitオブジェクトの初期化
2. サーボチャンネルの選択
3. 角度の設定
4. 待機時間の確保
5. 次の角度への移動（繰り返し）
6. 終了時の安全停止

#### 5.2.2 複数制御フロー
1. ServoKitオブジェクトの初期化
2. 使用チャンネルリストの定義
3. 動作パターンの定義
4. パターンのループ処理
   - 各サーボへの角度設定
   - 待機時間
5. 終了時の全サーボ安全停止

## 6. テスト要件

### 6.1 動作確認項目

#### 6.1.1 ハードウェアテスト
- I2C通信の確認（`i2cdetect -y 1`で0x40検出）
- Servo HATの電源供給確認
- サーボモーター配線の確認

#### 6.1.2 ソフトウェアテスト
- ライブラリインポートの確認
- 基本制御プログラムの動作確認
- 複数制御プログラムの動作確認
- 異常終了時の安全停止確認

### 6.2 検証基準
- サーボが指定角度に正確に移動すること
- 複数サーボが同期して動作すること
- Ctrl+C終了時に中央位置に復帰すること
- エラー発生時に適切なメッセージが表示されること

## 7. 制約事項

### 7.1 技術的制約
- 同時制御可能なサーボ数: 最大16個（1枚のHATあたり）
- サーボ角度範囲: 0-180度
- PWM周波数: 50Hz固定（サーボモーター仕様）

### 7.2 運用制約
- Raspberry Piより先に外部電源を投入すること
- サーボに過負荷をかけないこと（ストールトルク以下の負荷）
- I2Cアドレスの重複回避

### 7.3 安全制約
- サーボモーター用外部電源とRaspberry Pi電源の分離
- 適切な電源容量の確保
- はんだ付け作業時の安全確保

## 8. スケジュール

### 8.1 開発フェーズ
| フェーズ | 内容 | 期間 |
|---|---|---|
| フェーズ1 | 環境構築・ハードウェアセットアップ | - |
| フェーズ2 | 基本制御プログラム開発 | - |
| フェーズ3 | 複数制御プログラム開発 | - |
| フェーズ4 | ドキュメント作成 | - |
| フェーズ5 | テスト・検証 | - |

## 9. 参考情報

### 9.1 技術仕様参照先
- Adafruit Servo HAT公式ドキュメント
- PCA9685データシート
- SG90サーボモーター仕様書
- CircuitPython ServoKitライブラリドキュメント

### 9.2 関連技術
- PWM（Pulse Width Modulation）制御
- I2C通信プロトコル
- Raspberry Pi GPIOプログラミング
